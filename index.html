<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Koreksi Data Siswa</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 2rem;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      color: #0066cc;
    }
    label {
      font-weight: 600;
      margin-top: 1rem;
      display: block;
    }
    input[type="text"], textarea {
      width: 100%;
      padding: 0.6rem;
      margin-top: 0.3rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-bottom: 1rem;
    }
    button {
      background-color: #0066cc;
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: 1rem;
    }
    button:hover {
      background-color: #0055aa;
    }
    .field-group {
      margin-bottom: 1rem;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
    }
    .checkbox-group input {
      margin-right: 0.5rem;
    }
    .hidden {
      display: none;
    }
    .result-box {
      background: #eaf4ff;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Koreksi Data Siswa</h2>
    <div class="field-group">
      <label for="nisnCari">Masukkan NISN:</label>
      <input type="text" id="nisnCari" placeholder="Contoh: 1234567890" />
      <button onclick="cariData()">Cari Data</button>
    </div>
    <div id="hasilPencarian"></div>

    <form id="formPerbaikan" class="hidden">
      <div id="formKoreksi"></div>
      <label for="catatan">Catatan Tambahan:</label>
      <textarea id="catatan" rows="3" placeholder="Tulis jika ada penjelasan tambahan..."></textarea>
      <button type="button" onclick="kirimKoreksi()">Kirim Koreksi</button>
      <button type="button" onclick="tandaiSesuai()">Tandai Data Sudah Sesuai</button>
    </form>
    <div id="pesan"></div>
  </div>

  <script>
    let dataSiswa = null;
    const form = document.getElementById("formPerbaikan");
    const hasil = document.getElementById("hasilPencarian");
    const formKoreksi = document.getElementById("formKoreksi");
    const pesan = document.getElementById("pesan");

    async function cariData() {
      hasil.innerHTML = "⏳ Memuat data...";
      form.classList.add("hidden");
      pesan.innerHTML = "";

      const nisn = document.getElementById("nisnCari").value.trim();
      if (!nisn) {
        hasil.innerHTML = "⚠️ Masukkan NISN terlebih dahulu.";
        return;
      }

      const url = `https://script.google.com/macros/s/AKfycby9DrJTG_1Gc6Sabdj2k2LyO_Cp0ueUnY39ixsic7b9Q6E4AW004otzJMbQ2X40YtsV/exec?nisn=${encodeURIComponent(nisn)}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.error) {
          hasil.innerHTML = `<div class="result-box">❌ NISN tidak ditemukan.</div>`;
          return;
        }

        dataSiswa = data;
        tampilkanData(data);
      } catch (err) {
        hasil.innerHTML = "❌ Gagal mengambil data.";
      }
    }

    function tampilkanData(data) {
      hasil.innerHTML = `
        <div class="result-box">
          <strong>Nama:</strong> ${data.NAMA}<br/>
          <strong>NIS:</strong> ${data.NIS}<br/>
          <strong>NISN:</strong> ${data.NISN}<br/>
          <strong>Tempat Lahir:</strong> ${data.TEMPAT LAHIR}<br/>
          <strong>Tanggal Lahir:</strong> ${data.TANGGAL LAHIR}<br/>
          <strong>Nama Ayah:</strong> ${data.NAMA AYAH}<br/>
          <strong>Nama Ibu:</strong> ${data.NAMA IBU}
        </div>
      `;
      formKoreksi.innerHTML = buatFormKoreksi(data);
      form.classList.remove("hidden");
    }

    function buatFormKoreksi(data) {
      const kolom = ["NAMA", "NIS", "NISN", "TEMPAT_LAHIR", "TANGGAL_LAHIR", "NAMA_AYAH", "NAMA_IBU"];
      return kolom.map(key => `
        <div>
          <label class="checkbox-group">
            <input type="checkbox" onchange="toggleInput('${key}')" id="cek_${key}"> Perbaiki ${key.replace("_", " ").replace("_", " ")}
          </label>
          <input type="text" id="input_${key}" class="hidden" placeholder="Masukkan ${key.replace("_", " ").toLowerCase()}" />
        </div>
      `).join("");
    }

    function toggleInput(field) {
      const checkbox = document.getElementById("cek_" + field);
      const input = document.getElementById("input_" + field);
      if (checkbox.checked) {
        input.classList.remove("hidden");
      } else {
        input.classList.add("hidden");
      }
    }

    async function kirimKoreksi() {
      const perbaikan = {};
      const fields = ["NAMA", "NIS", "NISN", "TEMPAT_LAHIR", "TANGGAL_LAHIR", "NAMA_AYAH", "NAMA_IBU"];
      let ada = false;
      fields.forEach(key => {
        const cek = document.getElementById("cek_" + key);
        const val = document.getElementById("input_" + key).value.trim();
        if (cek.checked && val) {
          perbaikan[key] = val;
          ada = true;
        }
      });

      if (!ada) {
        alert("⚠️ Pilih dan isi minimal satu perbaikan.");
        return;
      }

      const payload = {
        nisn: dataSiswa.NISN,
        nama: dataSiswa.NAMA,
        catatan: document.getElementById("catatan").value.trim(),
        perbaikan: perbaikan
      };

      await fetch("https://script.google.com/macros/s/AKfycby9DrJTG_1Gc6Sabdj2k2LyO_Cp0ueUnY39ixsic7b9Q6E4AW004otzJMbQ2X40YtsV/exec", {
        method: "POST",
        body: JSON.stringify(payload),
        headers: { "Content-Type": "application/json" }
      });

      pesan.innerHTML = `<div class="success">✅ Koreksi berhasil dikirim.</div>`;
    }

    async function tandaiSesuai() {
      const payload = {
        nisn: dataSiswa.NISN,
        nama: dataSiswa.NAMA
      };

      await fetch("https://script.google.com/macros/s/AKfycby9DrJTG_1Gc6Sabdj2k2LyO_Cp0ueUnY39ixsic7b9Q6E4AW004otzJMbQ2X40YtsV/exec", {
        method: "POST",
        body: JSON.stringify(payload),
        headers: { "Content-Type": "application/json" }
      });

      pesan.innerHTML = `<div class="success">✅ Data ditandai sebagai sesuai.</div>`;
    }
  </script>
</body>
</html>
